import type { PlasmoMessaging } from "@plasmohq/messaging";
import type { Severity } from "../../utils/secshield-sdk";

export interface ReportVulnerabilityRequest {
	conversationId: string;
	url: string;
	severity: Severity;
	type: string;
	description: string;
}

export interface ReportVulnerabilityResponse {
	success: boolean;
	message: string;
	vulnerabilityId?: string;
}

const handler: PlasmoMessaging.MessageHandler<
	ReportVulnerabilityRequest,
	ReportVulnerabilityResponse
> = async (req, res) => {
	if (!req.body) {
		return res.send({
			success: false,
			message: "No request body",
		});
	}
	const { conversationId, url, severity, type, description } = req.body;

	console.log(
		`[report-vulnerability] üìã Reporting vulnerability for conversation ${conversationId}:`,
		{ url, severity, type },
	);

	try {
		// Get the conversation manager
		const { getConversation } = await import("../conversation-manager");
		const conversation = getConversation(conversationId);

		if (!conversation) {
			console.error(`[report-vulnerability] ‚ùå Conversation ${conversationId} not found`);
			return res.send({
				success: false,
				message: "Conversation not found",
			});
		}

		// Check if scan is initialized
		if (!conversation.scanId) {
			console.error(`[report-vulnerability] ‚ùå No scan initialized for conversation ${conversationId}`);
			return res.send({
				success: false,
				message: "No scan initialized. Cannot report vulnerability.",
			});
		}

		// Store vulnerability in conversation state
		if (!conversation.vulnerabilities) {
			conversation.vulnerabilities = [];
		}

		const vulnerability = {
			url,
			severity,
			type,
			description,
			timestamp: new Date().toISOString(),
		};

		conversation.vulnerabilities.push(vulnerability);

		console.log(
			`[report-vulnerability] ‚úÖ Vulnerability stored. Total vulnerabilities: ${conversation.vulnerabilities.length}`,
		);

		res.send({
			success: true,
			message: `Vulnerability reported successfully. Scan ID: ${conversation.scanId}`,
			vulnerabilityId: `temp-${Date.now()}`, // Temporary ID until we sync with API
		});
	} catch (error) {
		console.error("[report-vulnerability] ‚ùå Error reporting vulnerability:", error);
		res.send({
			success: false,
			message: `Failed to report vulnerability: ${error instanceof Error ? error.message : String(error)}`,
		});
	}
};

export default handler;

